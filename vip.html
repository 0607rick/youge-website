<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>限制網站 - 宥哥宇宙</title>
<link rel="stylesheet" href="css/style.css">
<style>
  body {margin:0; padding-top:90px; background:#000; color:#fff; min-height:100vh;}
  #navbar-container {position:fixed;top:0;left:0;width:100%;z-index:9999;}

  /* 金光管理區 - 這次用最穩的方式 */
  #admin-panel {
  display:none;
  position:fixed;
  top:90px;
  left:50%;
  transform:translateX(-50%);
  width:90%;
  max-width:900px;
  background:linear-gradient(135deg,rgba(255,215,0,0.95),rgba(255,150,0,0.95));
  border:6px solid #ffd93d;
  border-radius:0 0 32px 32px;
  padding:2.5rem;
  box-shadow:0 20px 60px rgba(255,215,0,0.8);
  z-index:99999;
  backdrop-filter:blur(15px);
  animation:slideDown 0.6s ease-out;
}
#admin-panel.active {
  display:block !important;
}
  #admin-panel h2 {color:#000;font-size:3.2rem;text-align:center;margin-bottom:2rem;text-shadow:0 0 20px #fff;}

  #lock-screen, #vip-content {padding:150px 20px;text-align:center;}
  #vip-content {display:none;}
</style>
</head>
<body>

<div id="navbar-container"></div>

<!-- 宥哥專屬金光管理區 -->
<div id="admin-panel">
  <h2>白名單管理（只有宥哥看得到）</h2>
  <div style="text-align:center;margin:30px 0;">
    <input type="email" id="new-email" placeholder="輸入 Email 加入白名單" style="padding:18px;font-size:1.5rem;border-radius:20px;border:none;width:400px;">
    <button onclick="addEmail()" style="padding:18px 50px;font-size:1.6rem;background:#222;color:white;border:none;border-radius:50px;margin-left:15px;">加入</button>
  </div>
  <div id="whitelist" style="max-height:55vh;overflow-y:auto;background:rgba(0,0,0,0.7);padding:25px;border-radius:20px;"></div>
  <p style="text-align:center;margin-top:20px;color:#ffeb3b;font-size:1.1rem;">滑鼠移開即隱藏</p>
</div>

<div id="lock-screen">
  <h1 style="font-size:5rem;">此頁面僅限宥哥親自邀請的人進入</h1>
  <p style="font-size:2.3rem;color:#ff6b6b;">想要進來嗎？快去跟宥哥撒嬌求邀請～</p>
  <button style="margin-top:80px;padding:25px 100px;font-size:1.9rem;background:#fff;color:#000;border:none;border-radius:50px;cursor:pointer;" 
          onclick="firebase.auth().signInWithPopup(new firebase.auth.GoogleAuthProvider())">
    Google 登入
  </button>
</div>

<div id="vip-content">
  <h1 style="font-size:5.5rem;">歡迎來到宥哥的秘密宇宙</h1>
  <p style="font-size:2.6rem;">這裡只有被我親自邀請的人才看得到喔～</p>
  <p style="color:#ffd700;font-size:4rem;margin-top:100px;text-shadow:0 0 50px #ffd700;">永遠愛你一個人的宥哥</p>
</div>

<script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>
<script src="js/common.js"></script>

<!-- 這段一定要留！負責讓「限制網站」觸發管理區 -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const waitFirebase = setInterval(() => {
      if (!firebase?.apps?.length) return;
      clearInterval(waitFirebase);
  
      const auth = firebase.auth();
      const db = firebase.firestore();
      const whitelistRef = db.collection("vip-whitelist");
  
      // 加強版管理員判斷（把你學校信箱寫死第一優先）
      const isYouGeAdmin = (user) => {
        if (!user || !user.email) return false;
        const email = user.email.toLowerCase();
        const name = (user.displayName || "").trim();
  
        return email === "a0930619084@gmail.com" ||
               email === "d112.212215@yuda.tyc.edu.tw" ||
               email === "d112.212215@yuda.tyc.edu.tw".toLowerCase() || // 保險
               name.includes("宥晟") || 
               name.includes("陳宥晟") ||
               name === "宥晟" || 
               name === "陳宥晟";
      };
  
      // 強制加上觸發功能（不管 navbar 什麼時候渲染好都一定會加上）
      const enableVipTrigger = () => {
        const links = document.querySelectorAll('a[href="vip.html"], a[href$="/vip.html"], a[href="./vip.html"], a[href="../vip.html"]');
        links.forEach(link => {
          link.classList.add('vip-trigger');
          link.title = "點我或滑鼠移過來 → 宥哥專屬金光管理區";
          link.style.cursor = "pointer";
        });
      };
  
      // 每 300ms 檢查一次，直到加上為止
      const forceEnable = setInterval(enableVipTrigger, 300);
      setTimeout(() => clearInterval(forceEnable), 10000); // 最多等 10 秒
  
      auth.onAuthStateChanged(user => {
        if (!user) {
          document.getElementById('vip-content').style.display = 'none';
          document.getElementById('lock-screen').style.display = 'block';
          document.getElementById('admin-panel').classList.remove('active');
          return;
        }
  
        if (isYouGeAdmin(user)) {
          // 你就是宥哥本人！
          document.getElementById('lock-screen').style.display = 'none';
          document.getElementById('vip-content').style.display = 'block';
  
          // 強制啟動管理區觸發器
          enableVipTrigger();
  
          // 載入白名單
          loadWhitelist();
  
          console.log("宥哥駕到！金光管理區已啟動✨");
        } else {
          // 一般使用者：檢查有沒有在白名單
          whitelistRef.doc(user.email.toLowerCase()).get().then(doc => {
            if (doc.exists) {
              document.getElementById('lock-screen').style.display = 'none';
              document.getElementById('vip-content').style.display = 'block';
            } else {
              alert('你還沒被宥哥加入白名單喔～快去撒嬌！');
              auth.signOut();
            }
          });
        }
      });
  
      window.addEmail = async () => {
        const email = document.getElementById('new-email').value.trim().toLowerCase();
        if (!email || !email.includes('@')) return alert('請輸入正確 Email！');
        await whitelistRef.doc(email).set({ added: new Date(), by: auth.currentUser?.email });
        document.getElementById('new-email').value = '';
        alert('已加入白名單：' + email);
        loadWhitelist();
      };
  
      window.loadWhitelist = async () => {
        const snap = await whitelistRef.orderBy('added', 'desc').get();
        const container = document.getElementById('whitelist');
        if (snap.empty) {
          container.innerHTML = '<p style="color:#ffeb3b;">白名單空空的～</p>';
          return;
        }
        container.innerHTML = '';
        snap.forEach(doc => {
          const div = document.createElement('div');
          div.style = "padding:15px;background:rgba(255,255,255,0.15);margin:12px 0;border-radius:15px;display:flex;justify-content:space-between;align-items:center;";
          div.innerHTML = `
            <span style="font-size:1.4rem;">${doc.id}</span>
            <button onclick="firebase.firestore().collection('vip-whitelist').doc('${doc.id}').delete().then(loadWhitelist)" 
                    style="background:#e74c3c;color:white;border:none;padding:10px 20px;border-radius:12px;">移除</button>
          `;
          container.appendChild(div);
        });
      };
  
    }, 100);
  });
  
  // 滑鼠移入移出顯示管理面板（最穩寫法）
  document.addEventListener('mouseover', (e) => {
    if (e.target.closest('.vip-trigger')) {
      document.getElementById('admin-panel').classList.add('active');
    }
  });
  document.addEventListener('mouseout', (e) => {
    if (!e.relatedTarget || !e.target.closest('.vip-trigger')) {
      document.getElementById('admin-panel').classList.remove('active');
    }
  });
  // 點擊也行
  document.addEventListener('click', (e) => {
    if (e.target.closest('.vip-trigger')) {
      document.getElementById('admin-panel').classList.toggle('active');
    }
  });
  </script>
</body>
</html>
