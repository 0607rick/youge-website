<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>留言板 - 宥哥宇宙</title>
  <link rel="stylesheet" href="css/style.css">
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>
  <style>
    .delete-btn{background:#e74c3c;color:white;border:none;padding:0.5rem 1rem;border-radius:8px;cursor:pointer;font-size:0.9rem;}
    .delete-btn:hover{background:#c0392b;}
    .comment{margin:2rem 0;padding:1.8rem;background:white;border-radius:20px;box-shadow:0 6px 20px rgba(0,0,0,0.1);}
    #comments-list p{text-align:center;color:#aaa;margin:6rem 0;font-size:1.3rem;}
    #nickname-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:9999;align-items:center;justify-content:center;}
    #nickname-modal.active{display:flex;}
    .nickname-box{background:white;padding:3rem 2.5rem;border-radius:24px;text-align:center;max-width:90%;box-shadow:0 20px 60px rgba(0,0,0,0.4);}
    .nickname-box input{width:100%;padding:1.3rem;font-size:1.3rem;border-radius:12px;border:2px solid #ddd;margin:1.5rem 0;}
    .nickname-box button{background:#6e8efb;color:white;padding:1rem 3rem;border:none;border-radius:50px;cursor:pointer;font-size:1.3rem;font-weight:bold;}
    #guestbook-form{max-width:700px;margin:3rem auto;padding:2.5rem;background:white;border-radius:24px;box-shadow:0 15px 50px rgba(0,0,0,0.15);}
  </style>
</head>
<body>

  <!-- 導覽列容器（一定要有！） -->
  <div id="navbar-container"></div>

  <main class="content" style="padding-top:100px;">
    <h1 style="text-align:center;font-size:3rem;color:#6e8efb;margin-bottom:2rem;">留言板</h1>

    <!-- 首次登入彈窗 -->
    <div id="nickname-modal">
      <div class="nickname-box">
        <h2>歡迎加入宥哥宇宙！</h2>
        <p>請設定你的專屬暱稱～</p>
        <input type="text" id="new-nickname" placeholder="輸入你想顯示的名字" maxlength="15">
        <button onclick="saveNickname()">確認送出</button>
      </div>
    </div>

    <div id="guestbook-form">
      <input type="text" id="name" placeholder="載入中..." readonly style="background:#f8f9fa;">
      <textarea id="message" rows="6" placeholder="在宥哥宇宙留個言吧～" required></textarea>
      <button id="submit-comment">送出留言</button>
    </div>

    <div id="comments-list"></div>
  </main>

  <!-- 只留這一行！所有 Firebase 都在 common.js 裡面 -->
  <script src="js/common.js"></script>

  <script>
    // 強制等 common.js 載入完畢 + Firebase 初始化完成後再執行
    window.addEventListener('load', () => {
      // 確保 auth 和 db 已經存在
      if (typeof firebase === 'undefined' || !firebase.auth || !firebase.firestore) {
        console.error('Firebase 還沒載入！');
        return;
      }

      const auth = firebase.auth();
      const db = firebase.firestore();
      let currentUserDisplayName = '';

      // 登入狀態監聽
      auth.onAuthStateChanged(async (user) => {
        if (user) {
          const doc = await db.collection("users").doc(user.uid).get();
          if (!doc.exists) {
            document.getElementById('nickname-modal').classList.add('active');
            document.getElementById('new-nickname').focus();
          } else {
            currentUserDisplayName = doc.data().displayName;
            document.getElementById('name').value = currentUserDisplayName;
          }
        }
      });

      // 儲存暱稱
      window.saveNickname = async () => {
        const nickname = document.getElementById('new-nickname').value.trim();
        if (!nickname) return alert('請輸入暱稱！');
        if (!auth.currentUser) return alert('請先登入！');

        await db.collection("users").doc(auth.currentUser.uid).set({
          displayName: nickname,
          photoURL: auth.currentUser.photoURL || '',
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });

        document.getElementById('nickname-modal').classList.remove('active');
        currentUserDisplayName = nickname;
        document.getElementById('name').value = nickname;
        alert('暱稱設定成功！歡迎加入宥哥宇宙～');
      };

      // 送出留言
      document.getElementById('submit-comment').onclick = async () => {
        if (!auth.currentUser) return alert('請先登入！');
        if (!currentUserDisplayName) return alert('請先設定暱稱！');
        const msg = document.getElementById('message').value.trim();
        if (!msg) return alert('請輸入留言內容！');

        try {
          await db.collection('comments').add({
            name: currentUserDisplayName,
            message: msg,
            photoURL: auth.currentUser.photoURL || '',
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            uid: auth.currentUser.uid
          });
          document.getElementById('message').value = '';
          alert('留言成功！');
        } catch (e) {
          alert('留言失敗，請再試一次');
        }
      };

      // 即時載入留言
      db.collection('comments')
        .orderBy('timestamp', 'desc')
        .onSnapshot(snap => {
          const list = document.getElementById('comments-list');
          list.innerHTML = snap.empty ? '<p style="text-align:center;color:#999;margin:6rem 0;font-size:1.3rem;">快來當第一個留言的人吧～</p>' : '';
          
          snap.forEach(doc => {
            const c = doc.data();
            const time = c.timestamp ? new Date(c.timestamp.toDate()).toLocaleString('zh-TW') : '剛剛';
            const isAdmin = auth.currentUser?.email === 'a0930619084@gmail.com';

            list.innerHTML += `
              <div class="comment">
                <div style="display:flex;align-items:center;gap:15px;margin-bottom:12px;">
                  ${c.photoURL ? `<img src="${c.photoURL}" style="width:50px;height:50px;border-radius:50%;object-fit:cover;">` : '<div style="width:50px;height:50px;background:#eee;border-radius:50%;"></div>'}
                  <div style="flex:1;">
                <strong style="font-size:1.2rem;">${c.name}</strong>
                    <small style="color:#888;">${time}</small>
                  </div>
                  ${isAdmin ? `<button class="delete-btn" onclick="firebase.firestore().collection('comments').doc('${doc.id}').delete()">刪除</button>` : ''}
                </div>
                <p style="margin:0;line-height:1.8;word-break:break-word;">${c.message.replace(/\n/g, '<br>')}</p>
              </div>
            `;
          });
        });
    });
    </script>
</body>
</html>